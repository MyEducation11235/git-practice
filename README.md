# Доменная модель для "Система управления доставками", используя принципы **Domain-Driven Design (DDD)**

## Описание предметной области

* Краткое введение в проблему, которую решает система.
	Система управления доставками предназначена для отслеживания посылок и оптимизации маршрутов курьеров. 
	В условиях растущей конкуренции в сфере логистики и доставки товаров, компании сталкиваются с необходимостью повышения эффективности своих процессов, улучшения клиентского сервиса и снижения затрат. 
	Основной проблемой является недостаточная видимость статуса доставки, что приводит к недовольству клиентов и увеличению числа обращений в службу поддержки.

* Основные бизнес-процессы и ключевые правила.
	• Создание заказа: Пользователь создает заказ на доставку, указывая тип отправляемого товара, адрес отправления и назначения.
	• Управление курьерами: Администраторы могут назначать курьеров на заказы и контролировать их загрузку.
	• Оптимизация маршрутов: Система автоматически рассчитывает оптимальные маршруты для курьеров на основе текущих заказов и дорожной ситуации.
	• Уведомления: Система отправляет уведомления пользователям о статусе их посылок.
	• Отслеживание посылки: Пользователь может отслеживать статус своей посылки в реальном времени.
	

## Определение основных сущностей. Описание их атрибутов и поведения

1. Заказ (Order)
	* Атрибуты: 
		ID
		адрес отправления
		адрес назначения
		статус (в обработке(создан), собирается, ожидает курьера, в пути к месту выдачи, доставка задерживается, ожидает получения, получен, отменён заказчиком, отеменён службой доставки)
		дата создания
		ID пользователя (кто создал заказал, это может быть как клиент, так и администатор)
		ID посылки
	* Поведение: 
		обновление статуса

2. Посылка (Parcel)
	* Атрибуты: 
		ID
		масса
		размеры (м * м * м)
		содержимое
		место хранения
		статус (в обработке(создана), собирается, нет требуемого товара, упаковывается, готова к отправке, доставлена, получена клиентом)
	* Поведение:
		обновление статуса
		сборка
		упаковка

3. Курьер (Courier)
	* Атрибуты: 
		ID
		ФИО
		номер телефона
		email
		ID транспортного средства
	* Поведение:  
		обновление статуса заказов
		смена транспортного средства

4. Транспортное средство (Transport vehicle)
	* Атрибуты: 
		ID
		регистрационный номер
		размер, отведённый под груз (м * м * м)
		суммарная грузоподъёмность
		статус (не активно, ожидает маршрута, ожидает загрузки, загрузка, в пути к месту назначения, в пути к месту загрузки)
		местоположение
		ID назначенных маршрутов (список)
	* Поведение: 
		обновление статуса
		расчет оставшегося места
		расчет оставшейся грузоподъёмности
		назначение на маршрут
		обновление своего местоположеия при движении
	
5. Маршрут (Route)
	* Атрибуты: 
		ID
		список точек (адресов)
		время в пути
		ID закреплённых заказов (список)
	* Поведение: 
		расчет маршрута
		оптимизация маршрута
		расчет времени доставки
		добавление заказов
		расчет требуемого места
		расчет требуемой грузоподъёмности
		
6. Администратор (Administrator)
	* Атрибуты: 
		ID
		ФИО
		номер телефона
		email
		пароль адимнистратора
		статус (активен, заблокирован)
	* Поведение: 
		отслеживание статуса транспортных средств
		отслеживание статуса посылок
		отслеживание статуса заказа
		решение внештатных ситуаций
		создание заказов для внутреннего перемещения посылок между местами хранения
		
7. Клиент (Client)
	* Атрибуты: 
		ID
		имя
		номер телефона
		статус (активен, заблокирован)
	* Поведение: 
		создание заказа
		отслеживание статуса заказа
		получение заказов
		

## Определение агрегатов и границ консистентности

#### Агрегаты

1. Заказ (Order)
	* Содержит сущность Заказ.
	* Содержит данные о заказе и ссылку на посылку.

2. Посылка (Parcel)
	* Содержит сущность Посылка.
	* Содержит данные о посылке.
	
3. Курьер (Courier)
	* Содержит сущность Курьер.
	* Содержит данные о курьере и ссылку на транспортное средство.
	
4. Транспортное средство (Transport vehicle)
	* Содержит сущность Транспортное средство.
	* Содержит данные о Транспортном средстве и назваченный на него маршрут.
	
5. Маршрут (Route)
	* Содержит сущность Маршрут.
	* Содержит данные о маршруте и ссылки на выполняемые этим маршрутом заказы.
		
6. Администратор (Administrator)
	* Содержит сущность Администратор.
	* Содержит данные о профиле администратора.			
	
7. Клиент (Client)
	* Содержит сущность Клиент.
	* Содержит данные о профиле клинта.
		
#### Границы консистентности

1. Данные Посылки и Заказа должны быть строго консистентны (например, нельзя изменять Посылку, если она уже часть заказа. Можно изменть только её статус, что должно повлечь изменение статуса Заказа).
2. Курьеры могут быть слабо связаны с Транспортным средствами (от транспортного средства не зависят характеристики курьера, даже в рамках одного заказа ничего не мешает менять курьера).
3. Маршруты могут быть слабо связаны с Транспортным средствами (характеристики транспорта не зависят от изменений маршрута).
4. Данные Маршрута и Заказа должны быть строго консистентны (например, если заказ был отменён, то маршрут должен быть перестроен с учётом этого).
5. Заказы могут быть слабо связаны с Клиент/Администратора (пользователя) (характеристики заказа не зависят от изменений от профиля создателя заказа).
	
## Разделение на контексты (Bounded Contexts)

1. Управление пользователями (User Management):
	* Ответственность: регистрация, аутентификация, управление профилями.
	  
2. Управление заказами (Order management)
	* Ответственность: создание, отмена
	  
3. Управление курьерами (Courier management)
	* Ответственность: аутентификация курьера, закрепление транспортнотого средства за курьером
	  
4. Управление транспортными средствами (Transport vehicle management)
	* Ответственность: регистрация, удаление, назначение на маршрут, обновление статусов, отслеживание местополложения транспорта
	  
5. Оркестратор (Route)
	* Ответственность: расчет ожидаемого времени доставки, составление маршрутов из заказов и доступного транспорта, адаптация маршрута в реальном времени, обновление статусов заказов
		
6. Администратор (Administrator)
	* Ответственность: регистрация, аутентификация, контроль работы оркестратора, решение внештатных ситуаций
	
7. Управление посылками (Parcel management) 
	* Ответственность: добавление, удаление посылок из системы, обновление места хранения посылок
	
## Диаграмма связей сущностей

* ER-диаграмма или схематическое представление связей.
	Заказ (1) - (1) посылка
	Заказ (1) - (1) пользователь
	Курьер (1) - (1) транспортное средство
	Транспортное средство (1) - (n) маршрут
	Маршрут (1) - (n) заказов
	
## Описание взаимодействия контекстов
	
* Прямые связи:
	* "Оркестратор" и "Управление заказами": подписки на изменения + запрос-ответ. Получение исходных и конечных точек для заказов, реагирование на отмены заказов, изменение статусов заказов.
	* "Оркестратор" и "Управление транспортными средствами": подписки на изменения. Для составления маршрутов и их адаптации нужно отслежавать статусы и местопололожение всех машин.
	* "Оркестратор" и "Управление посылками": запрос-ответ. Должен знать характиристики груза для его составления маршрута перевозки
	* "Администратор" и "Оркестратор": запрос-ответ. Администратор может обращаться к оркестратару в случае необходимости перестрокий маршрута. (Например при внештатной ситуации)
	
* Асинхронные события:
	* "Управление заказами" и "Управление посылками": события. Завершение заказа должно изменить место хранения посылки и статус заказа.
	* "Управление курьерами" и "Управление транспортными средствами": запрос-ответ. Получение данных о сущесвующих транспортных средствах для проверки условий, требуеых для закрепления их за курьерами.
	* "Администратор" и "Управление транспортными средствами": подписки на изменения. Администратор может в реальном времени следить за статусами, местопололожением и другими данными всего доступного транспорта.
		
## Примеры доменных сценариев

#### Сценарий 1: Создание заказа клиентом
	
1. Контекст: "Управление пользователями"
* Пользователь проходит проверку статуса (активен / заблокирован).
* Аутентификация через запрос-ответ.

2. Контекст: "Управление заказами"
Через запрос-ответ клиент отправляет запрос на создание нового заказа, указывая адреса, тип товара и другую информацию.
Создается запись о заказе с начальным статусом: в обработке (создан).

3. Далее, в какое то определённое время (например раз в день) Оркестратор составит маршруты для выполнения новых заказов

#### Сценарий 2: "Построение маршрутов"

1. Оркестратор собирает список новых заказов и доступных транспортных средств.
	* Запрашивает статусы машин у контекста "Управление транспортными средствами".
	* Получает параметры транспортов (объем, грузоподъёмность, текущее местоположение).
	* Получает размеры и местоположение посылок

2. Выполняется построение маршрутов:
	* Оркестратор распределяет заказы между доступнми транспортными средствами, учитывая размеры посылок и характеристики транспорта.
	* Оркестратор рассчитывает оптимальный маршрут с учетом адресов, дорожной ситуации, расстояний для каждого транспорта.
	* Полученный маршруты назначается на машины, для которых они составлялись.
	* Рассчитывается ожидемое время доставки для каждого заказа

3. Оркестратор уведомляет контекст "Управление заказами" об изменении статусов заказов.
	* Заказ получает статус «ожидает курьера».

4. Далее, когда курьер готов к новому маршруту (он пришёл на работу, или закончил пред заказ), он посылает запрос на маршрут для своего текущего транспортного средства.

#### Сценарий 3: "Решение внештатной ситуации администратором (авария транспортного средства)"

1. Получает данные об выбывшем транспорте из "Управление транспортными средствами"
	* местоположение транспорта
	* его размеры
	
2. Получает возможное решение ситуации от Оркестратора
	* Какой сейчас есть свободный транспорт, готовый заменить выбывший, где он находится. 
	* Новое ожидаемое время доставки
	* Характеристики товаров, доставка которых задержвается

3. Корректирует предложение в случаен необходимости
	* Возможно стоит разбить маршрут на несколько разных или другие нестандартные решения.

4. Переназначает маршрут на другой транспорт. 
	* Возможно привлекает доболнительных курьеров в случаен их недостатка.

5. Если сильно нарушаются сроки доставки, уведомляет об этом клиентов отдельмы сообщением или звонком.

## Описание доменных сервисов

1. Сервис расчета стоимости доставки (в Order Management)
	* Назначение: вычислить цену доставки на основе массы посылки, расстояния, типа доставки и приоритетов.
	* Причина: логика не относится напрямую к сущности «Заказ» или «Посылка», а учитывает множество параметров.
	* Тип: доменный сервис (бизнес-логика)

2. Сервис построения маршрутов (в Orchestrator)
	* Назначение: формировать оптимальные маршруты на основе доступных заказов, транспорта, дорожной ситуации.
	* Причина: агрегирует данные из разных источников (транспорт, заказы, посылки), сложно разместить внутри отдельного агрегата.
	* Тип: доменный сервис

3. Сервис расчета свободного места в транспорте (в Transport Vehicle Management)
	* Назначение: вычисляет доступный объем и грузоподъемность при добавлении нового заказа.
	* Причина: не хранит собственное состояние, но оперирует атрибутами разных заказов и транспорта.
	* Тип: доменный сервис

4. Сервис уведомлений (в нескольких контекстах)
	* Назначение: отправка уведомлений пользователям (изменения статуса, ожидается доставка и пр.)
	* Причина: кросс-контекстная техническая логика (часто может быть вынесен в отдельный микросервис).
	* Тип: инфраструктурный/доменный сервис в зависимости от реализации.

5. Сервис изменения статусов заказов и посылок (в Order и Parcel Management)
	* Назначение: централизованно управляет переходами между статусами (включая бизнес-ограничения).
	* Причина: обеспечивает целостность и соблюдение бизнес-правил при изменении состояний.
	* Тип: доменный сервис

* Где нужна бизнес-логика, а где просто CRUD-операции.	

	| Контекст                 | Только CRUD                     | Бизнес-логика                                       |
	| ------------------------ | ------------------------------- | --------------------------------------------------- |
	| **User Management**      | Регистрация, обновление профиля | Аутентификация, валидация статусов                  |
	| **Order Management**     | Создание/удаление заказов       | Расчет стоимости, изменение статусов                |
	| **Courier Management**   | Регистрация/удаление курьеров   | Назначение транспорта                               |
	| **Transport Management** | Добавление транспорта           | Расчет вместимости, обновление местоположения       |
	| **Orchestrator**         | —                               | Построение маршрутов, перерасчет при отмене заказов |
	| **Parcel Management**    | CRUD по посылке                 | Статусная логика, упаковка, сборка                  |
	| **Administrator**        | —                               | Обработка инцидентов, внутренние заказы             |
